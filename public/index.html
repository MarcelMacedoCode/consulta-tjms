<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta Processual — TJMS</title>
<meta name="description" content="Consulte processos judiciais do TJMS via DataJud + eSAJ + eproc">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚖</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0f1a; --surface: #111827; --surface-2: #1a2236; --surface-3: #232d42;
    --border: #2a3550; --border-light: #354264;
    --text: #e8ecf4; --text-muted: #8896b3; --text-dim: #5a6a8a;
    --accent: #3b82f6; --accent-glow: rgba(59,130,246,0.15); --accent-hover: #60a5fa;
    --green: #34d399; --green-bg: rgba(52,211,153,0.08);
    --amber: #fbbf24; --amber-bg: rgba(251,191,36,0.06);
    --red: #f87171; --red-bg: rgba(248,113,113,0.08);
    --purple: #a78bfa; --purple-bg: rgba(167,139,250,0.08);
    --cyan: #22d3ee; --cyan-bg: rgba(34,211,238,0.08);
    --radius: 10px; --radius-sm: 6px;
  }

  body {
    font-family: 'DM Sans', sans-serif; background: var(--bg);
    color: var(--text); min-height: 100vh; overflow-x: hidden;
  }

  .noise { position: fixed; inset: 0; z-index: 0; opacity: 0.025; pointer-events: none;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  .glow-orb { position: fixed; width: 600px; height: 600px; border-radius: 50%;
    background: radial-gradient(circle, rgba(59,130,246,0.06) 0%, transparent 70%);
    top: -200px; right: -200px; pointer-events: none; z-index: 0; }

  .app { position: relative; z-index: 1; max-width: 960px; margin: 0 auto; padding: 40px 24px 80px; }

  /* Header */
  .header { text-align: center; margin-bottom: 44px; }
  .header-badge {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--accent-glow); border: 1px solid rgba(59,130,246,0.2);
    border-radius: 20px; padding: 5px 14px;
    font-size: 12px; font-weight: 500; color: var(--accent-hover);
    letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 20px;
  }
  .header-badge .dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .header h1 {
    font-size: 32px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 8px;
    background: linear-gradient(135deg, #fff 0%, #8896b3 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .header p { color: var(--text-muted); font-size: 15px; line-height: 1.5; }

  /* Search Card */
  .search-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px; margin-bottom: 32px;
    position: relative; overflow: hidden;
  }
  .search-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, rgba(59,130,246,0.3), transparent);
  }
  .search-label { font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 10px; display: block; }
  .form-row { display: flex; gap: 12px; align-items: end; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.grow { flex: 1; }

  .search-input-wrap { position: relative; }
  .search-input-wrap .icon {
    position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
    color: var(--text-dim); pointer-events: none; width: 18px; height: 18px;
  }
  .search-input {
    width: 100%; background: var(--surface-2); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 14px 16px 14px 44px;
    font-family: 'DM Mono', monospace; font-size: 15px; color: var(--text);
    outline: none; transition: border-color 0.2s, box-shadow 0.2s;
  }
  .search-input::placeholder { color: var(--text-dim); font-family: 'DM Sans', sans-serif; }
  .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

  .search-btn {
    background: var(--accent); color: #fff; border: none; border-radius: var(--radius);
    padding: 14px 28px; font-family: 'DM Sans', sans-serif; font-size: 14px;
    font-weight: 600; cursor: pointer; transition: background 0.2s, transform 0.1s;
    white-space: nowrap; display: flex; align-items: center; gap: 8px; height: 48px;
  }
  .search-btn:hover { background: var(--accent-hover); }
  .search-btn:active { transform: scale(0.97); }
  .search-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .search-hint { font-size: 12px; color: var(--text-dim); margin-top: 12px; }
  .search-hint code { font-family: 'DM Mono', monospace; background: var(--surface-2); padding: 2px 6px; border-radius: 4px; font-size: 11px; color: var(--text-muted); }

  /* Source badges */
  .source-badges { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 12px; }
  .source-badge {
    font-size: 11px; font-weight: 500; padding: 3px 10px; border-radius: 12px;
    display: inline-flex; align-items: center; gap: 4px;
  }
  .source-badge .dot { width: 5px; height: 5px; border-radius: 50%; }
  .source-badge.active { border: 1px solid; }
  .source-badge.inactive { background: var(--surface-2); color: var(--text-dim); border: 1px solid var(--border); }
  .source-badge.datajud.active { background: var(--green-bg); color: var(--green); border-color: rgba(52,211,153,0.25); }
  .source-badge.datajud .dot { background: var(--green); }
  .source-badge.esaj.active { background: var(--accent-glow); color: var(--accent-hover); border-color: rgba(59,130,246,0.25); }
  .source-badge.esaj .dot { background: var(--accent); }
  .source-badge.eproc.active { background: var(--purple-bg); color: var(--purple); border-color: rgba(167,139,250,0.25); }
  .source-badge.eproc .dot { background: var(--purple); }

  /* Loading */
  .loading { text-align: center; padding: 48px; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; margin: 0 auto 16px; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--text-muted); font-size: 14px; }
  .loading-text small { display: block; margin-top: 6px; color: var(--text-dim); font-size: 12px; }

  /* Error / Not found */
  .error-card { background: var(--red-bg); border: 1px solid rgba(248,113,113,0.2); border-radius: var(--radius); padding: 20px 24px; color: var(--red); font-size: 14px; line-height: 1.6; animation: fadeUp 0.3s ease; }
  .error-card strong { display: block; margin-bottom: 4px; }
  .not-found { background: var(--amber-bg); border: 1px solid rgba(251,191,36,0.2); border-radius: var(--radius); padding: 24px; color: var(--amber); font-size: 14px; line-height: 1.6; text-align: center; animation: fadeUp 0.3s ease; }

  /* Result Card */
  .result-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; animation: fadeUp 0.4s ease; margin-bottom: 16px; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

  .result-header {
    padding: 24px 28px; border-bottom: 1px solid var(--border);
    display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; flex-wrap: wrap;
  }
  .result-numero { font-family: 'DM Mono', monospace; font-size: 17px; font-weight: 500; color: var(--accent-hover); }
  .result-tribunal { font-size: 12px; font-weight: 500; color: var(--text-muted); background: var(--surface-2); padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border); white-space: nowrap; }
  .result-body { padding: 24px 28px; }

  .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 28px; }
  .info-item { display: flex; flex-direction: column; gap: 4px; }
  .info-label { font-size: 11px; font-weight: 500; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.8px; }
  .info-value { font-size: 14px; color: var(--text); line-height: 1.4; }
  .info-value.mono { font-family: 'DM Mono', monospace; font-size: 13px; }

  /* Tags */
  .tags { display: flex; flex-wrap: wrap; gap: 6px; }
  .tag { background: var(--surface-3); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 12px; color: var(--text-muted); }

  /* Section titles */
  .section-title {
    font-size: 14px; font-weight: 600; color: var(--text);
    margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
    padding-top: 12px; border-top: 1px solid var(--border); margin-top: 8px;
  }
  .section-title .count { background: var(--accent-glow); color: var(--accent-hover); font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 500; }
  .section-title .fonte-tag { font-size: 10px; font-weight: 500; padding: 2px 7px; border-radius: 8px; margin-left: auto; }
  .fonte-tag.esaj { background: var(--accent-glow); color: var(--accent-hover); }
  .fonte-tag.eproc { background: var(--purple-bg); color: var(--purple); }
  .fonte-tag.datajud { background: var(--green-bg); color: var(--green); }

  /* Parties */
  .partes-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
  .parte-item {
    background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px 18px; display: flex; gap: 14px; align-items: flex-start;
  }
  .parte-tipo {
    font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--amber); background: var(--amber-bg); border: 1px solid rgba(251,191,36,0.15);
    padding: 3px 10px; border-radius: 20px; white-space: nowrap; flex-shrink: 0; margin-top: 2px;
  }
  .parte-tipo.autor, .parte-tipo.requerente, .parte-tipo.exequente, .parte-tipo.impetrante { color: var(--accent-hover); background: var(--accent-glow); border-color: rgba(59,130,246,0.2); }
  .parte-tipo.reu, .parte-tipo.requerido, .parte-tipo.executado, .parte-tipo.impetrado { color: var(--red); background: var(--red-bg); border-color: rgba(248,113,113,0.2); }
  .parte-info { flex: 1; min-width: 0; }
  .parte-nome { font-size: 14px; font-weight: 500; color: var(--text); margin-bottom: 4px; }
  .parte-advogados { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
  .parte-advogados .adv-icon { color: var(--text-dim); margin-right: 4px; }

  /* Timeline */
  .timeline { position: relative; padding-left: 20px; }
  .timeline::before { content: ''; position: absolute; left: 5px; top: 8px; bottom: 8px; width: 1px; background: var(--border); }
  .timeline-item { position: relative; padding-bottom: 18px; padding-left: 16px; }
  .timeline-item:last-child { padding-bottom: 0; }
  .timeline-item::before {
    content: ''; position: absolute; left: -18px; top: 7px; width: 7px; height: 7px;
    border-radius: 50%; background: var(--accent); border: 2px solid var(--surface); box-shadow: 0 0 0 2px var(--border);
  }
  .timeline-item:first-child::before { background: var(--green); box-shadow: 0 0 0 2px rgba(52,211,153,0.3); }
  .timeline-date { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-dim); margin-bottom: 3px; }
  .timeline-text { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
  .timeline-text strong { color: var(--text); font-weight: 500; }

  .show-more-btn {
    background: var(--surface-2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 10px 16px;
    color: var(--text-muted); font-family: 'DM Sans', sans-serif;
    font-size: 13px; cursor: pointer; margin-top: 12px; width: 100%; transition: background 0.2s;
  }
  .show-more-btn:hover { background: var(--surface-3); color: var(--text); }

  /* Empty */
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
  .empty-state .icon-big { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
  .empty-state p { font-size: 14px; line-height: 1.6; }

  /* Footer */
  .footer { text-align: center; margin-top: 48px; padding-top: 24px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-dim); line-height: 1.6; }
  .footer a { color: var(--accent); text-decoration: none; }

  /* 2G card */
  .segundo-grau-card { margin-top: 16px; }
  .segundo-grau-card .result-header { background: var(--surface-2); }

  @media (max-width: 640px) {
    .app { padding: 24px 16px 60px; }
    .header h1 { font-size: 24px; }
    .form-row { flex-direction: column; }
    .search-card { padding: 20px; }
    .result-header { padding: 18px 20px; }
    .result-body { padding: 18px 20px; }
    .info-grid { grid-template-columns: 1fr; gap: 14px; }
    .parte-item { flex-direction: column; gap: 8px; }
  }
</style>
</head>
<body>
<div class="noise"></div>
<div class="glow-orb"></div>

<div class="app" id="app">
  <div class="header">
    <div class="header-badge"><span class="dot"></span>DataJud + eSAJ + eproc</div>
    <h1>Consulta Processual</h1>
    <p>Pesquise processos do TJMS — dados unificados de três fontes</p>
  </div>

  <div class="search-card">
    <div class="form-row">
      <div class="form-group grow">
        <label class="search-label" for="numero">Número do Processo (CNJ)</label>
        <div class="search-input-wrap">
          <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <input class="search-input" id="numero" type="text" placeholder="0800123-45.2023.8.12.0001" autocomplete="off" spellcheck="false">
        </div>
      </div>
      <div class="form-group">
        <label class="search-label">&nbsp;</label>
        <button class="search-btn" id="btn-buscar" onclick="buscar()">Consultar</button>
      </div>
    </div>
    <p class="search-hint">
      Formato CNJ: <code>NNNNNNN-DD.AAAA.J.TR.OOOO</code> — também aceita sem pontuação<br>
      Consulta DataJud (movimentações) + eSAJ (partes/advogados) + eproc (processos migrados)
    </p>
  </div>

  <div id="content">
    <div class="empty-state">
      <div class="icon-big">⚖</div>
      <p>Digite o número de um processo do TJMS<br>para consultar informações completas.</p>
    </div>
  </div>

  <div class="footer">
    Dados públicos: <a href="https://datajud-wiki.cnj.jus.br/api-publica/" target="_blank" rel="noopener">DataJud/CNJ</a> +
    <a href="https://esaj.tjms.jus.br/cpopg5/open.do" target="_blank" rel="noopener">eSAJ/TJMS</a> +
    <a href="https://www.tjms.jus.br/eproc" target="_blank" rel="noopener">eproc/TJMS</a><br>
    Processos sigilosos não são exibidos.
  </div>
</div>

<script>
const $content = document.getElementById('content');
const $numero = document.getElementById('numero');
const $btn = document.getElementById('btn-buscar');

$numero.addEventListener('keydown', e => { if (e.key === 'Enter') buscar(); });

function fmtDate(d) {
  if (!d) return '—';
  try { return new Date(d).toLocaleDateString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}); } catch { return d; }
}
function fmtDateShort(d) {
  if (!d) return '—';
  try { return new Date(d).toLocaleDateString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric'}); } catch { return d; }
}

function classeTipo(tipo) {
  const t = (tipo || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  if (['autor','autora','requerente','exequente','impetrante','reclamante','embargante'].some(k => t.includes(k))) return 'autor';
  if (['reu','re','requerido','requerida','executado','executada','impetrado','reclamado','embargado'].some(k => t.includes(k))) return 'reu';
  return '';
}

async function buscar() {
  const numero = $numero.value.trim();
  if (!numero) return $numero.focus();

  $btn.disabled = true;
  $btn.textContent = 'Buscando...';
  $content.innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <p class="loading-text">Consultando DataJud + eSAJ + eproc...
        <small>Isso pode levar alguns segundos</small>
      </p>
    </div>`;

  try {
    // Tenta rota completa (v2); se 404, fallback pra rota simples (v1)
    let resp = await fetch('/api/consulta-completa', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ numero })
    });

    // Fallback: servidor antigo sem a rota /consulta-completa
    if (resp.status === 404) {
      resp = await fetch('/api/consulta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ numero, tribunal: 'tjms' })
      });
      const fallback = await resp.json();
      if (!resp.ok) {
        $content.innerHTML = `<div class="error-card"><strong>⚠ Erro</strong>${fallback.error || 'Erro desconhecido.'}</div>`;
        return;
      }
      if (!fallback.total || !fallback.processos?.length) {
        $content.innerHTML = `<div class="not-found"><strong>Nenhum processo encontrado</strong><br>Verifique se o número está correto.</div>`;
        return;
      }
      // Converte resposta v1 pro formato v2
      const p = fallback.processos[0];
      renderResult({
        unificado: {
          numero: p.numeroProcesso || '',
          classe: p.classe?.nome || '',
          area: '', assuntos: p.assuntos?.map(a => a.nome || a.codigo) || [],
          assuntoPrincipal: p.assuntos?.[0]?.nome || '',
          orgaoJulgador: p.orgaoJulgador?.nome || '', juiz: '',
          distribuicao: p.dataAjuizamento || '', valorAcao: '',
          grau: p.grau || '', formato: p.formato?.nome || '',
          nivelSigilo: p.nivelSigilo, dataUltimaAtualizacao: p.dataHoraUltimaAtualizacao || '',
          partes: [], movimentacoes: (p.movimentos || []).sort((a,b) => new Date(b.dataHora||0) - new Date(a.dataHora||0)).map(m => ({
            data: m.dataHora || '', descricao: m.nome || m.codigo || '',
            complementos: (m.complementosTabelados||[]).map(c=>c.nome||c.descricao||c.valor||'').filter(Boolean),
            fonte: 'datajud'
          })),
          fontes: { datajud: true, esaj1g: false, esaj2g: false, eproc1g: false, eproc2g: false },
          segundoGrau: null,
        }
      });
      return;
    }

    const data = await resp.json();

    if (!resp.ok) {
      $content.innerHTML = `<div class="error-card"><strong>⚠ Erro</strong>${data.error || 'Erro desconhecido.'}</div>`;
      return;
    }

    const u = data.unificado;
    const temDados = u.numero || u.classe || u.partes?.length || u.movimentacoes?.length;

    if (!temDados && !data.datajud?.total) {
      $content.innerHTML = `<div class="not-found">
        <strong>Nenhum processo encontrado</strong><br>
        Não foi encontrado processo com esse número em nenhuma das fontes consultadas.<br>
        Verifique se o número está correto.
      </div>`;
      return;
    }

    renderResult(data);

  } catch (err) {
    $content.innerHTML = `<div class="error-card"><strong>⚠ Erro de conexão</strong>Não foi possível conectar ao servidor.</div>`;
  } finally {
    $btn.disabled = false;
    $btn.textContent = 'Consultar';
  }
}

function renderResult(data) {
  const u = data.unificado;
  const fontes = u.fontes || {};

  // Source badges
  const badgesHtml = `
    <div class="source-badges">
      <span class="source-badge datajud ${fontes.datajud ? 'active' : 'inactive'}"><span class="dot"></span>DataJud</span>
      <span class="source-badge esaj ${fontes.esaj1g ? 'active' : 'inactive'}"><span class="dot"></span>eSAJ 1G</span>
      <span class="source-badge esaj ${fontes.esaj2g ? 'active' : 'inactive'}"><span class="dot"></span>eSAJ 2G</span>
      <span class="source-badge eproc ${fontes.eproc1g ? 'active' : 'inactive'}"><span class="dot"></span>eproc 1G</span>
      <span class="source-badge eproc ${fontes.eproc2g ? 'active' : 'inactive'}"><span class="dot"></span>eproc 2G</span>
    </div>`;

  // Assuntos
  let assuntosHtml = '';
  const assuntos = u.assuntos?.length ? u.assuntos : (u.assuntoPrincipal ? [u.assuntoPrincipal] : []);
  if (assuntos.length) {
    assuntosHtml = `
      <div style="margin-bottom:24px">
        <span class="info-label" style="margin-bottom:8px;display:block">Assuntos</span>
        <div class="tags">${assuntos.map(a => `<span class="tag">${a}</span>`).join('')}</div>
      </div>`;
  }

  // Partes
  let partesHtml = '';
  if (u.partes?.length) {
    const fonteParte = fontes.esaj1g ? 'esaj' : (fontes.eproc1g ? 'eproc' : '');
    partesHtml = `
      <div class="section-title">
        Partes do Processo <span class="count">${u.partes.length}</span>
        ${fonteParte ? `<span class="fonte-tag ${fonteParte}">via ${fonteParte}</span>` : ''}
      </div>
      <div class="partes-list">
        ${u.partes.map(p => {
          const cls = classeTipo(p.tipo);
          const advsHtml = (p.advogados || []).filter(a => a.nome).map(a =>
            `<div><span class="adv-icon">↳</span> ${a.nome}${a.oab ? ` <span style="color:var(--text-dim)">(OAB: ${a.oab})</span>` : ''}</div>`
          ).join('');
          return `
            <div class="parte-item">
              <span class="parte-tipo ${cls}">${p.tipo || 'Parte'}</span>
              <div class="parte-info">
                <div class="parte-nome">${p.nome || '—'}</div>
                ${advsHtml ? `<div class="parte-advogados">${advsHtml}</div>` : ''}
              </div>
            </div>`;
        }).join('')}
      </div>`;
  }

  // Movimentações
  const movs = u.movimentacoes || [];
  let movsHtml = '';
  if (movs.length) {
    const fonteMovs = movs[0]?.fonte || 'datajud';
    const initial = movs.slice(0, 10);
    movsHtml = `
      <div class="section-title">
        Movimentações <span class="count">${movs.length}</span>
        <span class="fonte-tag ${fonteMovs}">via ${fonteMovs}</span>
      </div>
      <div class="timeline" id="timeline">
        ${initial.map(m => timelineItem(m)).join('')}
      </div>
      ${movs.length > 10 ? `<button class="show-more-btn" id="btn-more" onclick="showAllMov()">Ver todas as ${movs.length} movimentações</button>` : ''}`;
  }

  $content.innerHTML = `
    <div class="result-card">
      <div class="result-header">
        <div>
          <span class="result-numero">${u.numero || $numero.value.trim()}</span>
          ${badgesHtml}
        </div>
        <span class="result-tribunal">TJMS • ${u.grau || '—'}</span>
      </div>
      <div class="result-body">
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Classe Processual</span>
            <span class="info-value">${u.classe || '—'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Órgão Julgador</span>
            <span class="info-value">${u.orgaoJulgador || '—'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Juiz</span>
            <span class="info-value">${u.juiz || '—'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Área</span>
            <span class="info-value">${u.area || '—'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Distribuição</span>
            <span class="info-value mono">${u.distribuicao ? fmtDateShort(u.distribuicao) : '—'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Valor da Ação</span>
            <span class="info-value mono">${u.valorAcao || '—'}</span>
          </div>
          ${u.nivelSigilo != null ? `
          <div class="info-item">
            <span class="info-label">Sigilo</span>
            <span class="info-value">${u.nivelSigilo === 0 ? 'Público' : 'Nível ' + u.nivelSigilo}</span>
          </div>` : ''}
          ${u.formato ? `
          <div class="info-item">
            <span class="info-label">Formato</span>
            <span class="info-value">${u.formato}</span>
          </div>` : ''}
        </div>
        ${assuntosHtml}
        ${partesHtml}
        ${movsHtml}
      </div>
    </div>`;

  window._movimentos = movs;
}

function timelineItem(m) {
  const dateStr = m.fonte === 'datajud' ? fmtDate(m.data) : (m.data || '—');
  const complementos = (m.complementos || []).join(', ');
  const desc = m.descricao || m.nome || '—';
  return `
    <div class="timeline-item">
      <div class="timeline-date">${dateStr}</div>
      <div class="timeline-text">
        <strong>${desc}</strong>
        ${complementos ? ` — ${complementos}` : ''}
      </div>
    </div>`;
}

function showAllMov() {
  const tl = document.getElementById('timeline');
  const btn = document.getElementById('btn-more');
  if (!tl || !window._movimentos) return;
  tl.innerHTML = window._movimentos.map(m => timelineItem(m)).join('');
  if (btn) btn.outerHTML = `<button class="show-more-btn" onclick="showLessMov()">Mostrar menos</button>`;
}

function showLessMov() {
  const tl = document.getElementById('timeline');
  if (!tl || !window._movimentos) return;
  tl.innerHTML = window._movimentos.slice(0, 10).map(m => timelineItem(m)).join('');
  const container = tl.parentElement;
  const oldBtn = container.querySelector('.show-more-btn');
  if (oldBtn) oldBtn.outerHTML = `<button class="show-more-btn" id="btn-more" onclick="showAllMov()">Ver todas as ${window._movimentos.length} movimentações</button>`;
}
</script>
</body>
</html>
